<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>IZAR Flight Controller: üöÄ IZAR Flight Controller (IFC)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">IZAR Flight Controller<span id="projectnumber">&#160;1.0.0</span>
   </div>
   <div id="projectbrief">IZAR Flight Controller running with an ESP32.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search',true);
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('index.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">üöÄ IZAR Flight Controller (IFC) </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__r_e_a_d_m_e"></a></p>
<p><a class="el" href="md__l_i_c_e_n_s_e.html"><img src="https://img.shields.io/github/license/imanolpg/ifc" alt="License" class="inline"/></a></p>
<p><a href="https://platformio.org/"><img src="https://img.shields.io/badge/PlatformIO-ESP--IDF-green" alt="PlatformIO" class="inline"/></a></p>
<p>A flight controller for real-time data gathering, parachute deployment and status control.</p>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md5"></a>
üìù Introduction</h1>
<p>This firmware runs on an ESP-WROOM-32 microcontroller under ESP-IDF and FreeRTOS to manage the sensing, filtering, logging, and control required for a safe rocket flight.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Feature  </th><th class="markdownTableHeadCenter">Status  </th><th class="markdownTableHeadNone">Source  </th><th class="markdownTableHeadNone">Notes  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">MPU6050 IMU  </td><td class="markdownTableBodyCenter">‚úÖ  </td><td class="markdownTableBodyNone"><span class="tt">mpu6050_c.c</span>  </td><td class="markdownTableBodyNone">3-axis accel &amp; gyro  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">MS5611 Barometer  </td><td class="markdownTableBodyCenter">‚úÖ  </td><td class="markdownTableBodyNone"><span class="tt">ms5611_c.c</span>  </td><td class="markdownTableBodyNone">Pressure &amp; altitude  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">1D Kalman Filter  </td><td class="markdownTableBodyCenter">‚úÖ  </td><td class="markdownTableBodyNone"><span class="tt">kalman_filter.c</span>  </td><td class="markdownTableBodyNone">Customizable noise parameters  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">SD Card Logging  </td><td class="markdownTableBodyCenter">‚úÖ  </td><td class="markdownTableBodyNone"><span class="tt">sd_c.c</span>  </td><td class="markdownTableBodyNone">CSV output; Logging data every 200 ms  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">BLE Telemetry  </td><td class="markdownTableBodyCenter">‚úÖ  </td><td class="markdownTableBodyNone"><span class="tt">ble_c.c</span>  </td><td class="markdownTableBodyNone">Remove control and data dashboard  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Flight Control Logic  </td><td class="markdownTableBodyCenter">‚úÖ  </td><td class="markdownTableBodyNone"><span class="tt">flight_controller.c</span>  </td><td class="markdownTableBodyNone">Flight state machine  </td></tr>
</table>
<p>Below is a high-level diagram of task interactions and hardware components:</p>
<div class="image">
<object type="image/svg+xml" data="README-1.svg" style="pointer-events: none;"></object>
<div class="caption">
diagram</div></div>
    <h1 class="doxsection"><a class="anchor" id="autotoc_md6"></a>
üõ†Ô∏è FreeRTOS Task Architecture</h1>
<p>In order to maximize both cores on the ESP32, FreeRTOS is used to handle tasks, timers and parallel processing. Two FreeRTOS tasks handle the main algorithms on the Flight Controller.</p>
<ol type="1">
<li><b>SensorsReadingTask</b> (Priority 5, ~50‚ÄØHz loop) <br  />
</li>
<li><b>FlightControllerTask</b> (Priority 3, ~20 Hz loop)</li>
</ol>
<p>Tasks are created in <a class="el" href="main_8c.html#abce06be17fc37d675118a678a8100a36">app_main</a> after queue setup:</p>
<div class="fragment"><div class="line">xTaskCreate(<a class="code hl_function" href="sensors__reading_8c.html#ad557a866d91e02ace41a8a19840a236d">sensors_reading</a>, <span class="stringliteral">&quot;SensorsReadingTask&quot;</span>, 4096, NULL, 5, NULL);</div>
<div class="line">xTaskCreate(<a class="code hl_function" href="flight__controller_8c.html#a2b87314a79ed972691b8cd6faab0214a">flight_controller</a>, <span class="stringliteral">&quot;FlightControllerTask&quot;</span>, 4096, NULL, 3, NULL);</div>
<div class="ttc" id="aflight__controller_8c_html_a2b87314a79ed972691b8cd6faab0214a"><div class="ttname"><a href="flight__controller_8c.html#a2b87314a79ed972691b8cd6faab0214a">flight_controller</a></div><div class="ttdeci">void flight_controller()</div><div class="ttdoc">Main FreeRTOS task function for the flight controller.</div><div class="ttdef"><b>Definition</b> flight_controller.c:109</div></div>
<div class="ttc" id="asensors__reading_8c_html_ad557a866d91e02ace41a8a19840a236d"><div class="ttname"><a href="sensors__reading_8c.html#ad557a866d91e02ace41a8a19840a236d">sensors_reading</a></div><div class="ttdeci">void sensors_reading()</div><div class="ttdoc">Main FreeRTOS task function for reading all sensors.</div><div class="ttdef"><b>Definition</b> sensors_reading.c:34</div></div>
</div><!-- fragment --><div class="image">
<object type="image/svg+xml" data="README-2.svg" style="pointer-events: none;"></object>
<div class="caption">
diagram</div></div>
    <hr  />
<h2 class="doxsection"><a class="anchor" id="autotoc_md8"></a>
SensorsReading Task</h2>
<p>This task is in charge of reading information from the sensors, computing that information and sending it to the Flight Controller to decide when to fire the chute charges. It also servers two other goals: the first one is to save all the data into an SD card so that is available for review after flight. The second one is allowing a Bluetooth Low Energy (BLE) connection for real time data monitoring and deactivating the rocket status of PREPARING_FOR_FLIGHT.</p>
<ul>
<li><b>Init</b>: Configure SPI, I2C and BLE (based on active sensors).</li>
<li><b>Loop (20‚ÄØms delay)</b>:<ol type="1">
<li>Check if the Flight Controller is reporting a new rocket status</li>
<li>Read MPU6050 linear and angular accelerations</li>
<li>Read MS5611 pressure and temperature<ol type="a">
<li>Filter pressure and temperature</li>
<li>Compute altitude</li>
<li>Compute vertical speed (Œîaltitude / Œîtime)</li>
</ol>
</li>
<li>Log CSV line to SD card</li>
<li>Send new measurements to the Flight Controller Task</li>
<li>Update BLE data (‚â§2‚ÄØHz)</li>
</ol>
</li>
</ul>
<div class="image">
<object type="image/svg+xml" data="README-3.svg" style="pointer-events: none;"></object>
<div class="caption">
diagram</div></div>
    <h2 class="doxsection"><a class="anchor" id="autotoc_md9"></a>
FlightController Task</h2>
<p>This task is in charge of analyzing the sensors data and taking decisions. It is the responsible of changing the rocket status and of detecting the best moment for chute ejection charge firing.</p>
<ul>
<li><b>Init</b>: configuration of all variables and status</li>
<li><b>Process</b>: <br  />
<ol type="1">
<li>Read available data from xSensorsQueue</li>
<li>Calculate mobile mean for altitude</li>
<li>Depending on the rocket status, select the decision-making algorithm of that state</li>
<li>If the rocket status state has been updated, send it over xUpdateStatusFromFlightController to the SensorsReadingTask</li>
</ol>
</li>
</ul>
<div class="image">
<object type="image/svg+xml" data="README-4.svg" style="pointer-events: none;"></object>
<div class="caption">
diagram</div></div>
    <hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md11"></a>
üîÑ Inter-Task Communication</h1>
<ul>
<li><b>xSensorQueue</b> (length 1): <span class="tt">SensorDataQueue_t</span> from SensorsReading ‚Üí FlightController <br  />
</li>
<li><b>xUpdatedStatus</b> (length 1): <span class="tt">ROCKET_STATUS_T</span> from FlightController ‚Üí SensorsReading <br  />
</li>
</ul>
<p>Queues ensure thread-safe, mutex-free data passing. The single-slot design always delivers the latest data without backlog.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md12"></a>
xSensorQueue</h2>
<p>This queue is used to send data read and processed in the SensorsReading task to the Flight Controller. The SensorsReading task handles a more measurements than what FlightController needs so only the necessary information is sent. The information structures in the <a class="el" href="struct_sensor_data_queue__t.html">SensorDataQueue_t</a> structure. The structure contains:</p><ol type="1">
<li>The current rocket status. This is needed because the user can update though the BLE connection the status and the SensorsReading task is the one controlling it.</li>
<li>The current rocket altitude.</li>
<li>The rocket linear acceleration in axes X, Y and Z.</li>
</ol>
<div class="image">
<object type="image/svg+xml" data="README-5.svg" style="pointer-events: none;"></object>
<div class="caption">
diagram</div></div>
    <h2 class="doxsection"><a class="anchor" id="autotoc_md13"></a>
ROCKET_STATUS_T</h2>
<p>The only information that has to be sent from the FlightController task to the SensorsReading task is the new flight status. That is the reason why the queue has only the amount of space needed to fit this value.</p>
<ol type="1">
<li>Current rocket status determined by the FlightController task</li>
</ol>
<div class="image">
<object type="image/svg+xml" data="README-6.svg" style="pointer-events: none;"></object>
<div class="caption">
diagram</div></div>
    <hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md15"></a>
üö¶ Rocket Flight State Machine</h1>
<p>The Flight Controller relies on a Finite State Machine in order to determine the actions and steps it needs to take. This ensures safety measures and guarantees that actions occur in a certain order for a successful flight.</p>
<p>As a safety measurement, the rocket will no deploy any ejection charges until the rocket status is manually updated via the BLE application. This ensures that no explosions occur during launchpad installation. The state machine also guarantees that parachutes are deployed in the correct order: first drogue and later main.</p>
<div class="image">
<object type="image/svg+xml" data="README-7.svg" style="pointer-events: none;"></object>
<div class="caption">
diagram</div></div>
    <ul>
<li><b>PREPARING_FOR_FLIGHT</b>: the controller is on and working but it will remain in this state until it is manually updated from the BLE connection. This is done for safety reasons so that if during manipulation charges are not ignited.</li>
<li><b>READY_TO_FLY</b>: the rocket is in the launch pad ready to fly. At this point the motor can be ignited and thanks to the acceleration liftoff will be automatically detected.</li>
<li><b>ASCENDING</b>: the rocket motor is on and it is going up. When apogee is detected the drogue chute will be deployed.</li>
<li><b>DESCENDING_WITH_DROGUE</b>: the rocket is falling with the drogue chute and is monitoring altitude for main chute deployment.</li>
<li><b>DESCENDING_WITH_MAIN</b>: the rocket is falling with the main chute.</li>
<li><b>LANDED</b>: the rocket has touched the ground.</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md17"></a>
üìä Data Logging &amp; Telemetry</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md18"></a>
CSV Logging:</h2>
<p>The SensorsReading task records all read data into the SD card for future processing. This helps retrieving all the information from the flight. The systems sores a new file called LOGX.CSV where X is an incremental number to keep all the previously recoded information. The information recorded is the next one:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Value  </th><th class="markdownTableHeadNone">Units  </th><th class="markdownTableHeadNone">Description  </th><th class="markdownTableHeadNone">Column name  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Time  </td><td class="markdownTableBodyNone">Milliseconds  </td><td class="markdownTableBodyNone">Time since boot  </td><td class="markdownTableBodyNone">Time(ms)  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Rocket status  </td><td class="markdownTableBodyNone">Enum  </td><td class="markdownTableBodyNone">Rocket status value  </td><td class="markdownTableBodyNone">RocketStatus  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Pressure  </td><td class="markdownTableBodyNone">Pascals  </td><td class="markdownTableBodyNone">Pressure inside the rocket  </td><td class="markdownTableBodyNone">Pressure(Pa)  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Altitude  </td><td class="markdownTableBodyNone">Meters  </td><td class="markdownTableBodyNone">Altitude of the rocket  </td><td class="markdownTableBodyNone">Altitude(m)  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Vertical speed  </td><td class="markdownTableBodyNone">m / s  </td><td class="markdownTableBodyNone">Vertical speed of the rocket  </td><td class="markdownTableBodyNone">VerticalSpeed(m/s)  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Temperature  </td><td class="markdownTableBodyNone">Degrees Celsius  </td><td class="markdownTableBodyNone">Temperature inside the rocket  </td><td class="markdownTableBodyNone">Temperature(¬∫C)  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Acceleration X  </td><td class="markdownTableBodyNone">G-Forces  </td><td class="markdownTableBodyNone">Linear acceleration in the X axis  </td><td class="markdownTableBodyNone">AccX(g)  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Acceleration Y  </td><td class="markdownTableBodyNone">G-Forces  </td><td class="markdownTableBodyNone">Linear acceleration in the Y axis  </td><td class="markdownTableBodyNone">AccY(g)  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Acceleration Z  </td><td class="markdownTableBodyNone">G-Forces  </td><td class="markdownTableBodyNone">Linear acceleration in the Z axis  </td><td class="markdownTableBodyNone">AccZ(g)  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Rotation X  </td><td class="markdownTableBodyNone">Degrees per second  </td><td class="markdownTableBodyNone">Angular speed of rotation in X axis  </td><td class="markdownTableBodyNone">RotX(¬∫/s)  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Rotation Y  </td><td class="markdownTableBodyNone">Degrees per second  </td><td class="markdownTableBodyNone">Angular speed of rotation in Y axis  </td><td class="markdownTableBodyNone">RotY(¬∫/s)  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Rotation Z  </td><td class="markdownTableBodyNone">Degrees per second  </td><td class="markdownTableBodyNone">Angular speed of rotation in Z axis  </td><td class="markdownTableBodyNone">RotZ(¬∫/s)  </td></tr>
</table>
<p>The file is flushed every loop. This strategy has been chosen due to the fact that, in case of a disaster, the SD card would contain up to the latest recorded value and would be helpful for analysis.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md19"></a>
BLE GATT</h2>
<p>Twice a second, the Flight Controller broadcasts over BLE sensor data and flight status parameters. This information can be read with a BLE client or with a custom made application for it. The BLE connection allows for communication and manually changing the value of the rocket status.</p>
<p>The custom application has been developed in Flutter and it is compatible with IOS, Android, macOS, Windows and Linux. Disclaimer: it has only been tested in Android and macOS.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md20"></a>
macOS screen captures</h3>
<p><img src="assets/macos-devices-scan.png" alt="macOS devices scan" width="45%" class="inline"/> <img src="assets/macos-main.png" alt="macos main screen" width="45%" class="inline"/> </p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md21"></a>
Android screen captures</h3>
<p><img src="assets/android-devices-scan.png" alt="macOS devices scan" width="25%" class="inline"/> <img src="assets/android-main.png" alt="macos main screen" width="25%" class="inline"/> </p>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md23"></a>
üõ°Ô∏è License</h1>
<p>Released under the Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) License with additional obligations.</p>
<p>¬© 2025 Imanol Gutierrez Pinedo. </p>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"></a>
</div><!-- contents -->
</div><!-- doc-content -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
